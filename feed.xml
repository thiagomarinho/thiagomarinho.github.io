<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="pt-br"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="thiagomarinho.net/feed.xml" rel="self" type="application/atom+xml" /><link href="thiagomarinho.net/" rel="alternate" type="text/html" hreflang="pt-br" /><updated>2024-02-26T22:37:39-03:00</updated><id>thiagomarinho.net/feed.xml</id><title type="html">Thiago Marinho</title><author><name>Thiago Marinho</name></author><entry xml:lang="pt-br"><title type="html">AWS - Obtendo account alias usando Terraform</title><link href="thiagomarinho.net/obtendo-aws-account-alias-usando-terraform/" rel="alternate" type="text/html" title="AWS - Obtendo account alias usando Terraform" /><published>2023-09-20T19:00:00-03:00</published><updated>2023-09-20T19:00:00-03:00</updated><id>thiagomarinho.net/obtendo-aws-account-alias-usando-terraform</id><content type="html" xml:base="thiagomarinho.net/obtendo-aws-account-alias-usando-terraform/"><![CDATA[<p>As vezes, pra fazer algum tipo de automação, é interessante utilizar o alias da conta AWS como parte do nome de algum recurso, como tag etc. Curiosamente, ao procurar por <code class="language-plaintext highlighter-rouge">alias</code> na <a href="">página da documentação do provider</a>, o que você encontra, dentre outros, é <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_account_alias">esse recurso</a>:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="s2">"aws_iam_account_alias"</span> <span class="s2">"current"</span> <span class="p">{}</span>

<span class="nx">output</span> <span class="s2">"account_id"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_iam_account_alias</span><span class="err">.</span><span class="nx">current</span><span class="err">.</span><span class="nx">account_alias</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Por conta de seu nome, pode parecer que ele é exatamente o que você precisa, mas na verdade, ele é utilizado para <a href="https://docs.aws.amazon.com/pt_br/IAM/latest/UserGuide/console_account-alias.html">personalizar a URL de login da sua conta</a>.</p>

<p>Ao invés disso, o que muito provavelmente você está procurando é o alias da conta dentro de sua organização; para obter esse valor, você pode utilizar esse código aqui:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="s2">"aws_caller_identity"</span> <span class="s2">"current"</span> <span class="p">{}</span>

<span class="nx">data</span> <span class="s2">"aws_organizations_organization"</span> <span class="s2">"org"</span> <span class="p">{}</span>

<span class="nx">locals</span> <span class="p">{</span>
  <span class="nx">aws_account_name</span> <span class="p">=</span> <span class="nx">compact</span><span class="err">(</span><span class="p">[</span><span class="nx">for</span> <span class="nx">account</span> <span class="nx">in</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_organizations_organization</span><span class="err">.</span><span class="nx">org</span><span class="err">.</span><span class="nx">accounts</span> <span class="err">:</span> <span class="nx">account</span><span class="err">.</span><span class="nx">id</span> <span class="err">==</span> <span class="nx">data</span><span class="err">.</span><span class="nx">aws_caller_identity</span><span class="err">.</span><span class="nx">current</span><span class="err">.</span><span class="nx">id</span> <span class="err">?</span> <span class="nx">account</span><span class="err">.</span><span class="nx">name</span> <span class="err">:</span> <span class="s2">""</span><span class="p">]</span><span class="err">)</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"account_alias"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">aws_account_name</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity">aws_caller_identity</a>;</li>
  <li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/organizations_organization">aws_organizations_organization</a>;</li>
  <li><a href="https://developer.hashicorp.com/terraform/language/functions/compact">Terraform - função <code class="language-plaintext highlighter-rouge">compact</code></a>;</li>
  <li><a href="https://developer.hashicorp.com/terraform/language/expressions/for">Terraform - expressões <code class="language-plaintext highlighter-rouge">for</code></a>.</li>
</ul>

<p>Inclusive poderia ser uma possível inclusão em um módulo <code class="language-plaintext highlighter-rouge">info</code>, caso você possua ou queira prover algo do tipo:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span> <span class="s2">"info"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="s2">"..."</span>
<span class="p">}</span>

<span class="nx">output</span> <span class="s2">"account_alias"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">info</span><span class="err">.</span><span class="nx">account_alias</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>MAS</strong></p>

<p>Esse código só vai funcionar se a identidade executando o código atualmente for a conta de gerenciamento da organização ou um delegated administrator:</p>

<ul>
  <li>https://docs.aws.amazon.com/pt_br/organizations/latest/APIReference/API_ListAccounts.html</li>
  <li>https://github.com/hashicorp/terraform-provider-aws/issues/18590</li>
</ul>

<p>Se não for esse seu caso, infelizmente ainda não há um datasource que retorne o alias apenas de sua conta; algo como descrito nessa issue (aberta):</p>

<ul>
  <li>https://github.com/hashicorp/terraform-provider-aws/issues/30656</li>
</ul>

<p>Por enquanto, se você estiver nesse cenário e realmente precisar usar esse alias, sua melhor opção é provavelmente utilizar esse comando do AWS CLI:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws organizations describe-account <span class="nt">--account-id</span> &lt;ACCOUNT-ID&gt;
</code></pre></div></div>

<p>E obter o alias a partir do retorno.</p>]]></content><author><name>Thiago Marinho</name></author><category term="aws" /><category term="terraform" /><summary type="html"><![CDATA[As vezes, pra fazer algum tipo de automação, é interessante utilizar o alias da conta AWS como parte do nome de algum recurso, como tag etc. Curiosamente, ao procurar por alias na página da documentação do provider, o que você encontra, dentre outros, é esse recurso:]]></summary></entry><entry xml:lang="pt-br"><title type="html">Azure Devops - Executando tarefas customizadas em um Environment Gate</title><link href="thiagomarinho.net/azure-devops-executando-tarefas-customizadas-em-um-environment-gate/" rel="alternate" type="text/html" title="Azure Devops - Executando tarefas customizadas em um Environment Gate" /><published>2022-08-08T19:03:00-03:00</published><updated>2022-08-08T19:03:00-03:00</updated><id>thiagomarinho.net/azure-devops-executando-tarefas-customizadas-em-um-environment-gate</id><content type="html" xml:base="thiagomarinho.net/azure-devops-executando-tarefas-customizadas-em-um-environment-gate/"><![CDATA[<p>Meu time estava explorando a possibilidade de criar uma <a href="https://github.com/microsoft/azure-pipelines-tasks/blob/master/docs/authoring/servertaskauthoring.md">tarefa customizada no Azure Devops</a> que seria executada em um <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/approvals?view=azure-devops&amp;tabs=check-pass">Environment Gate</a>.
Após alguns testes com uma extensão de exemplo que criamos, percebemos que, por algum motivo, nunca conseguimos ver nossa task customizada disponível para ser executada a partir do gate. Após uma ajuda extraordinária de um de nossos colegas do time com fascinantes skills googlísticas, descobrimos <a href="https://developercommunity.visualstudio.com/t/custom-servergate-not-available-in-environment-che/1576665#T-N1599182">qual era o problema e como corrigí-lo</a>:</p>

<blockquote>
  <p>(…) Até onde sei, a feature flag “Pipelines.Checks.EnableAllTaskChecks” precisa ser habilitada por nós da Microsoft.</p>
</blockquote>

<p>Então, se você eventualmente tiver um problema similar, abre um ticket pra o time de supporte da Microsoft pra que eles habilitem essa flag pra você :).</p>]]></content><author><name>Thiago Marinho</name></author><category term="azure-devops" /><category term="pipelines" /><category term="custom-extension" /><summary type="html"><![CDATA[Meu time estava explorando a possibilidade de criar uma tarefa customizada no Azure Devops que seria executada em um Environment Gate. Após alguns testes com uma extensão de exemplo que criamos, percebemos que, por algum motivo, nunca conseguimos ver nossa task customizada disponível para ser executada a partir do gate. Após uma ajuda extraordinária de um de nossos colegas do time com fascinantes skills googlísticas, descobrimos qual era o problema e como corrigí-lo:]]></summary></entry></feed>